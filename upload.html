<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Upload</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.csv.js"></script>
</head>
<body>
	<div id="upload">
		<div class="container">
			<div class="row">
				<div class="col-md-4 col-md-push-8">
					<div class="page-section text-left">
						<img src="images/slider_1.jpg" class="img-responsive img-bordered" id="upload-img">
						<h3 id="upload-type">省级等级符号地图</h3>
						<p id="upload-intro">将数据中的一列值，根据数值的大小，绘制不同等级的圆形符号（气泡），生成一幅专题地图。</p>
						<h3 class="warning">上传数据需知：</h3>
						<p>数据格式请参见左侧示例数据，支持CSV文件。</p>
						<p> <input type="file" id="files" name="files[]" /></p>
					</div>
				</div>
				<div class="col-md-8 col-md-pull-4">
					<h4>注意事项：</h4>
					<p id="notice">&nbsp;</p>
					<h4>示例数据：</h4>
					<div class="text-center upload-img"><img src="images/slider_1.jpg" class="img-responsive img-bordered" id="format-img"></div>
				</div>
			</div>
		</div>
	</div>
	<script>
		//获取index。html通过url传递的数据
		var mapUrl = "map.html"+decodeURI(location.search);
		function GetRequest() {
		  var url = decodeURI(location.search); 
		   var theRequest = new Object();
		   if (url.indexOf("?") != -1) {
		      var str = url.substr(1);
		      strs = str.split("&");
		      for(var i = 0; i < strs.length; i ++) {
		         theRequest[strs[i].split("=")[0]]=(strs[i].split("=")[1]);
		      }
		   }
		   return theRequest;
		}
		$(function(){
			var request =  new Object();
			request = GetRequest();
			var type = request["type"];
			var typeJson = new Array();
			//异步读取地图类型对应的信息
		    $.ajax({       
			    type:"POST",//请求方式  
			    url:"data/type.json",//请求路径  
			    dataType: "json",//数据格式  
			    success: function(resultData){//成功处理函数        
				    $.each(resultData,function(i,item){//遍历返回json数据，i为数据号，item当前数据  
				      	if (item["type"] == type) {
			      		typeJson.push(item["name"],item["introduction"],item["notice"]);
			      		$("#upload-type").text(typeJson[0]);
						$("#upload-intro").text(typeJson[1]);
						$("#notice").text(typeJson[2]);
						$("#format-img")[0].src = "images/type"+type+"-format.png";
						$("#upload-img")[0].src = "images/type"+type+".png";
		      		}
				    });  
			    } , 
			    error:function(){alert(arguments[1]);}
			});
			//上传数据
			if(isAPIAvailable()) {
		        $('#files').bind('change', handleFileSelect);
		     }
		});

		//上传数据功能实现
	    function isAPIAvailable() {
	      if (window.File && window.FileReader && window.FileList && window.Blob) {
	        return true;
	      } else {
	        document.writeln('The HTML5 APIs used in this form are only available in the following browsers:<br />');
	        document.writeln(' - Google Chrome: 13.0 or later<br />');
	        document.writeln(' - Mozilla Firefox: 6.0 or later<br />');
	        document.writeln(' - Internet Explorer: Not supported (partial support expected in 10.0)<br />');
	        document.writeln(' - Safari: Not supported<br />');
	        document.writeln(' - Opera: Not supported');
	        return false;
	      }
	    }
	    function handleFileSelect(evt) {
	      var files = evt.target.files;
	      var file = files[0];
	      getTableData(file);
	    }
	    function getTableData(file) {
	      var reader = new FileReader();
	      reader.readAsText(file);
	      reader.onload = function(event){
	       	csv = event.target.result;
	        window.open(encodeURI(mapUrl + "&data=" + csv));
	        window.close();
	      };
	      reader.onerror = function(){ alert('Unable to read' + file.fileName); };
	    }
	</script>
</body>
</html>